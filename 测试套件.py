# -*- coding: utf-8 -*-
"""
将军令语言 - 测试套件
"""

import sys
import os
import traceback

# 添加核心模块路径
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '核心'))

from 词法分析器 import 将军令词法分析器, 词法错误
from 语法分析器 import 将军令语法分析器, 语法错误
from 解释器 import 将军令解释器, 解释错误


class 将军令测试器:
    def __init__(self):
        self.词法分析器 = 将军令词法分析器()
        self.语法分析器 = 将军令语法分析器()
        self.解释器 = 将军令解释器()
        self.测试通过数 = 0
        self.测试总数 = 0
    
    def 运行测试(self, 测试名称, 源代码, 期望结果=None, 应该报错=False):
        self.测试总数 += 1
        print(f"\n{'='*60}")
        print(f"测试 {self.测试总数}: {测试名称}")
        print(f"{'='*60}")
        print(f"源代码:\n{源代码}")
        
        try:
            令牌列表 = self.词法分析器.分析(源代码)
            print(f"✓ 词法分析成功，生成 {len(令牌列表)} 个令牌")
            
            抽象语法树 = self.语法分析器.解析程序(令牌列表)
            print("✓ 语法分析成功")
            
            实际结果 = self.解释器.解释(抽象语法树)
            print(f"✓ 解释执行成功")
            
            if 应该报错:
                print(f"✗ 测试失败: 预期报错但执行成功")
                return False
            
            if 期望结果 is not None and 实际结果 != 期望结果:
                print(f"✗ 测试失败: 期望 {期望结果}，实际 {实际结果}")
                return False
            
            print(f"✓ 测试通过!")
            self.测试通过数 += 1
            return True
            
        except (词法错误, 语法错误, 解释错误) as e:
            if 应该报错:
                print(f"✓ 测试通过: 按预期报错 - {e}")
                self.测试通过数 += 1
                return True
            else:
                print(f"✗ 测试失败: 意外错误 - {e}")
                return False
        except Exception as e:
            print(f"✗ 测试失败: 系统错误 - {e}")
            traceback.print_exc()
            return False
    
    def 显示统计(self):
        print(f"\n{'='*60}")
        print(f"测试统计: {self.测试通过数}/{self.测试总数} 通过")
        print(f"{'='*60}")
        return self.测试通过数 == self.测试总数


def 运行功能测试():
    """运行功能测试"""
    测试器 = 将军令测试器()
    
    # 基础功能测试
    测试器.运行测试("基础输出", '报 "Hello, 将军令!"')
    
    测试器.运行测试("简单变量", '''
令：
    姓名 = "张三"
报 姓名
    ''')
    
    测试器.运行测试("数学运算", '''
令：
    甲 = 10
    乙 = 3
令行 和 = 甲 + 乙
报 和
    ''')
    
    测试器.运行测试("列表操作", '''
令：
    列表 = [1, 2, 3]
报 列表
    ''')
    
    # 函数调用测试
    测试器.运行测试("简单函数", '''
策 问候()：
    报 "你好"

策行 问候()
    ''')
    
    测试器.运行测试("带参数函数", '''
策 问候(姓名)：
    报 "你好，" + 姓名

策行 问候("张三")
    ''')
    
    测试器.运行测试("数学函数", '''
策 计算和(甲, 乙)：
    返 甲 + 乙

令行 结果 = 计算和(5, 3)
报 "5 + 3 = " + 结果
    ''')
    
    测试器.运行测试("条件语句", '''
令：
    分数 = 85
若 分数 >= 60 则：
    报 "及格"
    ''')
    
    测试器.运行测试("完整条件", '''
令：
    分数 = 45
若 分数 >= 60 则：
    报 "及格"
否则：
    报 "不及格"
    ''')
    
    测试器.运行测试("列表循环", '''
令：
    水果列表 = ["苹果", "香蕉", "橙子"]
访 水果 于 水果列表：
    报 "我喜欢吃" + 水果
    ''')
    
    测试器.运行测试("内置函数", '''
令：
    列表 = [1, 2, 3, 4, 5]
报 "列表长度：" + 长度(列表)
报 "列表类型：" + 类型(列表)
    ''')
    
    # 错误测试
    测试器.运行测试("除零错误", '''
令行 结果 = 10 / 0
    ''', 应该报错=True)
    
    测试器.运行测试("未定义变量", '''
报 未定义变量
    ''', 应该报错=True)
    
    return 测试器.显示统计()


def 运行错误恢复测试():
    """运行错误恢复测试"""
    print(f"\n{'='*60}")
    print("错误恢复测试")
    print(f"{'='*60}")
    
    测试用例 = [
        ("混合正确和错误代码", '''
令：
    正确变量 = 42
    错误变量 = @#$%  # 非法字符
报 "这部分应该执行：" + 正确变量
        '''),
        
        ("缺少冒号", '''
策 测试函数(参数)
    返 参数 * 2
        '''),
        
        ("不完整的列表", '''
令：
    列表 = [1, 2, 3  # 缺少右括号
报 列表
        ''')
    ]
    
    词法分析器 = 将军令词法分析器()
    语法分析器 = 将军令语法分析器()
    
    通过数 = 0
    总数 = len(测试用例)
    
    for 测试名称, 源代码 in 测试用例:
        print(f"\n错误恢复测试: {测试名称}")
        print(f"源代码:\n{源代码}")
        
        try:
            令牌列表 = 词法分析器.分析(源代码)
            print(f"词法分析生成 {len(令牌列表)} 个令牌")
            
            抽象语法树 = 语法分析器.解析程序(令牌列表)
            print("语法分析完成")
            
        except Exception as e:
            print(f"捕获错误: {e}")
            print("错误恢复机制工作正常")
            通过数 += 1
        
        print("-" * 40)
    
    print(f"\n错误恢复测试统计: {通过数}/{总数} 通过")
    return 通过数 == 总数


def 运行性能测试():
    """运行性能测试"""
    print(f"\n{'='*60}")
    print("性能测试")
    print(f"{'='*60}")
    
    测试代码 = '''
令：
    总和 = 0
报 "性能测试"
    '''
    
    import time
    开始时间 = time.time()
    
    词法分析器 = 将军令词法分析器()
    语法分析器 = 将军令语法分析器()
    解释器 = 将军令解释器()
    
    for i in range(10):
        令牌列表 = 词法分析器.分析(测试代码)
        抽象语法树 = 语法分析器.解析程序(令牌列表)
        解释器.解释(抽象语法树)
    
    结束时间 = time.time()
    总时间 = 结束时间 - 开始时间
    平均时间 = 总时间 / 10
    
    print(f"性能测试结果:")
    print(f"总执行时间: {总时间:.3f} 秒")
    print(f"平均执行时间: {平均时间:.3f} 秒")
    print(f"执行次数: 10 次")
    
    return 平均时间 < 1.0


if __name__ == "__main__":
    print("将军令语言测试套件")
    
    功能测试通过 = 运行功能测试()
    错误恢复测试通过 = 运行错误恢复测试()
    性能测试通过 = 运行性能测试()
    
    if 功能测试通过 and 错误恢复测试通过 and 性能测试通过:
        print("\n🎉 所有测试通过! 将军令语言运行正常。")
    else:
        print("\n❌ 部分测试失败，请检查实现。")